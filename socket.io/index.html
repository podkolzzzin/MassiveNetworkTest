<!DOCTYPE html>
<html>
<head lang="en">
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.2.1.js"></script>
    <style>
        .block {
            position: relative;
            top: 0px;
            left: 0px;
            width: 25px;
            height: 25px;
            background-color: red;
        }

        #users {
            background-color: green;
        }

        #field {
            width: 800px;
            height: 600px;
            border: 1px solid #000000;
            overflow: hidden;
        }

    </style>
    <meta charset="UTF-8">
    <title>Socket.io test</title>
    <script>
        var setPos = function (selector, x, y) {
            $(selector).css({
                left: x - $(selector).width() / 2,
                top: y - $(selector).height() / 2
            });
        };

        var create = function (selector, x, y) {
            $("#field").append("<div class='block' id = '" + selector.substr(1) + "'></div>");
            setPos(selector, x, y);
        };

        var startSocket = function () {
            if (document.location.protocol == "file:")
                return io('http://localhost:8888');
            else
                return io('http://' + document.location.hostname + ":8888");
        };

        var interval = null;
        var mouse = {x: 0, y: 0};

        $(document).ready(function () {
            var socket = startSocket();
            socket.on("move", function (data) {

                var el = $("#r-" + data.id);
                if (el.length == 0)
                    create('#r-' + data.id, data.x, data.y);
                else
                    setPos('#r-' + data.id, data.x, data.y);
            });

            $("#field, #users").mousemove(function (e) {

                var pos = $("#field").position();
                mouse = {x: e.pageX - pos.left, y: e.pageY - pos.top};
                if (interval != null)
                    return;

                socket.emit("move", mouse);
                setPos("#users", mouse.x, mouse.y);
            });

            $("#startCircling").click(function () {

                if ($("#startCircling").hasClass('start')) {

                    var block = $("#users").position();
                    var pos = {x: block.left, y: block.top};
                    var v = {x: pos.x - mouse.x, y: pos.y - mouse.y};
                    var r = 200;
                    var angle = Math.atan2(v.x, v.y);

                    interval = setInterval(function () {

                        angle += Math.PI / 120;
                        pos.x = Math.round(mouse.x + r * Math.sin(angle));
                        pos.y = Math.round(mouse.y + r * Math.cos(angle));
                        setPos("#users", pos.x, pos.y);
                        socket.emit("move", pos);
                    }, 15);
                    $("#startCircling").removeClass('start');
                } else {
                    clearInterval(interval);
                    interval = null;
                    $("#startCircling").addClass('start');
                }
            }).focus();
        });


    </script>
</head>
<body>
<div id="menu">
    <div>
        <label about="transport">
            Transport:
        </label>
        <select name="transport">
            <option>Socket.io</option>
            <option>WebSocket</option>
            <option>Http</option>
        </select>
        <label>
            Test:
        </label>
        <select name="test">
            <option>Follow Cursor</option>
            <option>Ping rendering</option>
        </select>
    </div>
</div>
<div id="test-fields">
    <div id="follow-cursor">

        <div id="field">
            <div class="block" id="users"></div>
        </div>
        <button id="startCircling" class="start">Start circling</button>
    </div>
</div>
<div id="description">

</div>
</body>
</html>